<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TemplateFilePathProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis FreeMarker</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.scripting.freemarker.support</a> &gt; <span class="el_source">TemplateFilePathProvider.java</span></div><h1>TemplateFilePathProvider.java</h1><pre class="source lang-java linenums">/*
 *    Copyright 2015-2022 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.scripting.freemarker.support;

import java.io.IOException;
import java.lang.reflect.Method;
import java.util.Optional;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

import org.apache.ibatis.builder.annotation.ProviderContext;
import org.apache.ibatis.io.Resources;
import org.mybatis.scripting.freemarker.FreeMarkerLanguageDriver;
import org.mybatis.scripting.freemarker.FreeMarkerLanguageDriverConfig;
import org.mybatis.scripting.freemarker.FreeMarkerLanguageDriverConfig.TemplateFileConfig.PathProviderConfig;

/**
 * The SQL provider class that return the SQL template file path.
 * &lt;p&gt;
 * &lt;b&gt;IMPORTANT: This class required to use with mybatis 3.5.1+&lt;/b&gt; and need to use with SQL provider annotation (such
 * as {@link org.apache.ibatis.annotations.SelectProvider} as follow:
 * &lt;p&gt;
 *
 * &lt;pre&gt;
 * package com.example.mapper;
 *
 * public interface BaseMapper&amp;lt;T&amp;gt; {
 *
 *   &amp;#64;Options(useGeneratedKeys = true, keyProperty = &quot;id&quot;)
 *   &amp;#64;InsertProvider(type = TemplateFilePathProvider.class)
 *   void insert(T entity);
 *
 *   &amp;#64;UpdateProvider(type = TemplateFilePathProvider.class)
 *   void update(T entity);
 *
 *   &amp;#64;DeleteProvider(type = TemplateFilePathProvider.class)
 *   void delete(T entity);
 *
 *   &amp;#64;SelectProvider(type = TemplateFilePathProvider.class)
 *   T findById(Integer id);
 *
 * }
 * &lt;/pre&gt;
 *
 * &lt;pre&gt;
 * package com.example.mapper;
 *
 * public interface NameMapper extends BaseMapper {
 *
 *   &amp;#64;SelectProvider(type = TemplateFilePathProvider.class)
 *   List&amp;lt;Name&amp;gt; findByConditions(NameConditions conditions);
 *
 * }
 * &lt;/pre&gt;
 *
 * @author Kazuki Shimizu
 *
 * @version 1.2.0
 */
public class TemplateFilePathProvider {

<span class="fc" id="L75">  private static final PathGenerator DEFAULT_PATH_GENERATOR = TemplateFilePathProvider::generateTemplatePath;</span>
  private static final FreeMarkerLanguageDriverConfig DEFAULT_LANGUAGE_DRIVER_CONFIG = FreeMarkerLanguageDriverConfig
<span class="fc" id="L77">      .newInstance();</span>

<span class="fc" id="L79">  private static PathGenerator pathGenerator = DEFAULT_PATH_GENERATOR;</span>
<span class="fc" id="L80">  private static FreeMarkerLanguageDriverConfig languageDriverConfig = DEFAULT_LANGUAGE_DRIVER_CONFIG;</span>

<span class="fc" id="L82">  private static ConcurrentMap&lt;ProviderContext, String&gt; cache = new ConcurrentHashMap&lt;&gt;();</span>

  private TemplateFilePathProvider() {
    // NOP
  }

  /**
   * Set custom implementation for {@link PathGenerator}.
   *
   * @param pathGenerator
   *          a instance for generating a template file path
   */
  public static void setCustomTemplateFilePathGenerator(PathGenerator pathGenerator) {
<span class="fc" id="L95">    TemplateFilePathProvider.pathGenerator = Optional.ofNullable(pathGenerator).orElse(DEFAULT_PATH_GENERATOR);</span>
<span class="fc" id="L96">  }</span>

  /**
   * Set a configuration instance for {@link FreeMarkerLanguageDriver}.
   * &lt;p&gt;
   * By default, {@link FreeMarkerLanguageDriverConfig#newInstance()} will used.
   * &lt;p&gt;
   * If you applied an user define {@link FreeMarkerLanguageDriverConfig} for {@link FreeMarkerLanguageDriver}, please
   * same instance to the this class.
   *
   * @param languageDriverConfig
   *          A user defined {@link FreeMarkerLanguageDriverConfig}
   */
  public static void setLanguageDriverConfig(FreeMarkerLanguageDriverConfig languageDriverConfig) {
<span class="fc" id="L110">    TemplateFilePathProvider.languageDriverConfig = Optional.ofNullable(languageDriverConfig)</span>
<span class="fc" id="L111">        .orElse(DEFAULT_LANGUAGE_DRIVER_CONFIG);</span>
<span class="fc" id="L112">  }</span>

  /**
   * Provide an SQL scripting string(template file path).
   * &lt;p&gt;
   * By default implementation, a template file path resolve following format and priority order. If does not match all,
   * it throw an exception that indicate not found a template file.
   * &lt;ul&gt;
   * &lt;li&gt;com/example/mapper/NameMapper/NameMapper-{methodName}-{databaseId}.ftl&lt;/li&gt;
   * &lt;li&gt;com/example/mapper/NameMapper/NameMapper-{methodName}.ftl (fallback using default database)&lt;/li&gt;
   * &lt;li&gt;com/example/mapper/BaseMapper/BaseMapper-{methodName}-{databaseId}.ftl (fallback using declaring class of
   * method)&lt;/li&gt;
   * &lt;li&gt;com/example/mapper/BaseMapper/BaseMapper-{methodName}.ftl (fallback using declaring class of method and default
   * database)&lt;/li&gt;
   * &lt;/ul&gt;
   *
   * @param context
   *          a context of SQL provider
   *
   * @return an SQL scripting string(template file path)
   */
  @SuppressWarnings(&quot;unused&quot;)
  public static String provideSql(ProviderContext context) {
<span class="fc bfc" id="L135" title="All 2 branches covered.">    return languageDriverConfig.getTemplateFile().getPathProvider().isCacheEnabled()</span>
<span class="fc" id="L136">        ? cache.computeIfAbsent(context, c -&gt; providePath(c.getMapperType(), c.getMapperMethod(), c.getDatabaseId()))</span>
<span class="fc" id="L137">        : providePath(context.getMapperType(), context.getMapperMethod(), context.getDatabaseId());</span>
  }

  /**
   * Clear cache.
   */
  public static void clearCache() {
<span class="fc" id="L144">    cache.clear();</span>
<span class="fc" id="L145">  }</span>

  static String providePath(Class&lt;?&gt; mapperType, Method mapperMethod, String databaseId) {
<span class="fc bfc" id="L148" title="All 2 branches covered.">    boolean fallbackDeclaringClass = mapperType != mapperMethod.getDeclaringClass();</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">    boolean fallbackDatabase = databaseId != null;</span>
<span class="fc" id="L150">    String path = pathGenerator.generatePath(mapperType, mapperMethod, databaseId);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">    if (exists(path)) {</span>
<span class="fc" id="L152">      return path;</span>
    }
<span class="fc bfc" id="L154" title="All 2 branches covered.">    if (fallbackDatabase) {</span>
<span class="fc" id="L155">      path = pathGenerator.generatePath(mapperType, mapperMethod, null);</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">      if (exists(path)) {</span>
<span class="fc" id="L157">        return path;</span>
      }
    }
<span class="fc bfc" id="L160" title="All 2 branches covered.">    if (fallbackDeclaringClass) {</span>
<span class="fc" id="L161">      path = pathGenerator.generatePath(mapperMethod.getDeclaringClass(), mapperMethod, databaseId);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">      if (exists(path)) {</span>
<span class="fc" id="L163">        return path;</span>
      }
<span class="fc bfc" id="L165" title="All 2 branches covered.">      if (fallbackDatabase) {</span>
<span class="fc" id="L166">        path = pathGenerator.generatePath(mapperMethod.getDeclaringClass(), mapperMethod, null);</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (exists(path)) {</span>
<span class="fc" id="L168">          return path;</span>
        }
      }
    }
<span class="fc" id="L172">    throw new IllegalStateException(&quot;The SQL template file not found. mapperType:[&quot; + mapperType + &quot;] mapperMethod:[&quot;</span>
        + mapperMethod + &quot;] databaseId:[&quot; + databaseId + &quot;]&quot;);
  }

  private static String generateTemplatePath(Class&lt;?&gt; type, Method method, String databaseId) {
<span class="fc" id="L177">    Package pkg = type.getPackage();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">    String packageName = pkg == null ? &quot;&quot; : pkg.getName();</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    String className = type.getName().substring(packageName.length() + (packageName.isEmpty() ? 0 : 1));</span>

<span class="fc" id="L181">    PathProviderConfig pathProviderConfig = languageDriverConfig.getTemplateFile().getPathProvider();</span>
<span class="fc" id="L182">    StringBuilder path = new StringBuilder();</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">    if (!pathProviderConfig.getPrefix().isEmpty()) {</span>
<span class="fc" id="L184">      path.append(pathProviderConfig.getPrefix());</span>
    }
<span class="fc bfc" id="L186" title="All 4 branches covered.">    if (pathProviderConfig.isIncludesPackagePath() &amp;&amp; !packageName.isEmpty()) {</span>
<span class="fc" id="L187">      path.append(packageName.replace('.', '/')).append('/');</span>
    }
<span class="fc" id="L189">    path.append(className);</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">    if (pathProviderConfig.isSeparateDirectoryPerMapper()) {</span>
<span class="fc" id="L191">      path.append('/');</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">      if (pathProviderConfig.isIncludesMapperNameWhenSeparateDirectory()) {</span>
<span class="fc" id="L193">        path.append(className).append('-');</span>
      }
    } else {
<span class="fc" id="L196">      path.append('-');</span>
    }
<span class="fc" id="L198">    path.append(method.getName());</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">    if (databaseId != null) {</span>
<span class="fc" id="L200">      path.append('-').append(databaseId);</span>
    }
<span class="fc" id="L202">    path.append(&quot;.ftl&quot;);</span>
<span class="fc" id="L203">    return path.toString();</span>
  }

  private static boolean exists(String path) {
<span class="fc" id="L207">    String basePath = languageDriverConfig.getTemplateFile().getBaseDir();</span>
<span class="fc bfc" id="L208" title="All 4 branches covered.">    String actualPath = basePath.isEmpty() ? path : basePath + (basePath.endsWith(&quot;/&quot;) ? &quot;&quot; : &quot;/&quot;) + path;</span>
    try {
<span class="fc" id="L210">      Resources.getResourceURL(actualPath);</span>
<span class="fc" id="L211">      return true;</span>
<span class="fc" id="L212">    } catch (IOException e) {</span>
<span class="fc" id="L213">      return false;</span>
    }
  }

  /**
   * The interface that implements a function for generating template file path.
   */
  @FunctionalInterface
  public interface PathGenerator {

    /**
     * Generate a template file path.
     *
     * @param type
     *          mapper interface type that specified provider (or declaring interface type of mapper method)
     * @param method
     *          a mapper method that specified provider
     * @param databaseId
     *          a database id that provided from {@link org.apache.ibatis.mapping.DatabaseIdProvider}
     *
     * @return a template file path
     */
    String generatePath(Class&lt;?&gt; type, Method method, String databaseId);

  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>